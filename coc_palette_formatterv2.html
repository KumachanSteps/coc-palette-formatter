
<!DOCTYPE html>
<html lang="ja">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-NJD5JZML31"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NJD5JZML31');
</script>
<meta charset="UTF-8">
<title>CoCキャラシート整形ツール V2</title>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 40px;
  background-color: #f9f9f9;
  display: flex;
  flex-direction: column;
  align-items: center;
}
header {
  margin-bottom: 30px;
  text-align: center;
}
header h1 {
  font-size: 28px;
  color: #333;
}
header p {
  font-size: 14px;
  color: #555;
}
.main {
  display: flex;
  justify-content: center;
  gap: 30px;
  max-width: 1200px;
  width: 100%;
}
.container {
  flex: 1;
  display: flex;
  flex-direction: column;
  max-width: 550px;
}
textarea {
  width: 100%;
  height: 600px;
  resize: none;
  padding: 10px;
  font-family: monospace;
  font-size: 14px;
  background-color: #fff;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-sizing: border-box;
}
button {
  margin-top: 10px;
  padding: 10px;
  font-size: 14px;
  cursor: pointer;
  border: none;
  border-radius: 4px;
  background-color: #007acc;
  color: #fff;
  transition: background-color 0.3s;
}
button:hover {
  background-color: #005f99;
}
</style>
</head>
<body>

<header>
  <h1>CoCキャラシート整形ツール V2</h1>
  <p>『キャラクター保管所』の「データ出力▶︎テキスト」をチャットパレットに整形します。</p>
</header>

<div class="main">
  <div class="container">
    <textarea id="input" placeholder="ここにチャットパレットを貼り付けてください"></textarea>
    <button onclick="formatPalette()">分類して出力</button>
  </div>

  <div class="container">
    <textarea id="output" readonly></textarea>
    <button onclick="copyOutput()">コピー</button>
  </div>
</div>

<script>
const initialValues = {
  'キック': 25, '組み付き': 25, '頭突き': 10, '投擲': 25, 'マーシャルアーツ': 1,
  '拳銃': 20, 'サブマシンガン': 15, 'ショットガン': 30, 'マシンガン': 15, 'ライフル': 25,
  '応急手当': 30, '鍵開け': 1, '隠す': 15, '隠れる': 10, '忍び歩き': 10, '写真術': 10, '精神分析': 1,
  '追跡': 10, '登攀': 40, '運転': 20, '機械修理': 20, '重機械操作': 1, '乗馬': 5, '水泳': 25,
  '製作': 5, '操縦': 1, '跳躍': 25, '電気修理': 10, 'ナビゲート': 10, '変装': 1,
  '言いくるめ': 5, '信用': 15, '説得': 15, '値切り': 5,
  '医学': 5, 'オカルト': 5, '化学': 1, '芸術': 5, '経理': 10, '考古学': 1, 'コンピューター': 1,
  '心理学': 5, '人類学': 1, '生物学': 1, '地質学': 1, '電子工学': 1, '天文学': 1, '博物学': 10, '物理学': 1, '法律': 5, '薬学': 1, '歴史': 20
};

function formatPalette() {
  const inputContent = document.getElementById("input").value;
  const lines = inputContent.split("\n");
  const categories = { dice: [], explore: [], battle: [], action: [], talk: [], knowledge: [], initial: [], status: [], damage: [] };
  const presentSkills = new Map();
  let str = 0, con = 0, pow = 0, dex = 0, app = 0, siz = 0, int = 0, edu = 0;
  let damageBonus = "0"; // Default damage bonus
  let sanValue = 70; // Default SAN value, will try to extract from input

  lines.forEach(line => {
    // Extract Ability Scores
    const statsMatch = line.match(/^=合計=\s+(\d+)\s+(\d+)\s+(\d+)\s+(\d+)\s+(\d+)\s+(\d+)\s+(\d+)\s+(\d+)/);
    if (statsMatch) {
      str = parseInt(statsMatch[1]);
      con = parseInt(statsMatch[2]);
      pow = parseInt(statsMatch[3]);
      dex = parseInt(statsMatch[4]);
      app = parseInt(statsMatch[5]);
      siz = parseInt(statsMatch[6]);
      int = parseInt(statsMatch[7]);
      edu = parseInt(statsMatch[8]);
    }

    // Extract Damage Bonus
    const damageBonusMatch = line.match(/ダメージボーナス：(.+)/);
    if (damageBonusMatch) {
      damageBonus = damageBonusMatch[1].trim();
    }
    
    // Extract SAN value from input (e.g., SAN: 70/99)
    const sanMatch = line.match(/SAN：(\d+)\/\d+/);
    if (sanMatch) {
        sanValue = parseInt(sanMatch[1]);
    }

    // Skill parsing for input format: [●]《SkillName》Value%
    const skillMatch = line.match(/《(.+?)》\s*(\d+)%?/);
    if (skillMatch) {
      let skillName = skillMatch[1].trim();
      const skillValue = parseInt(skillMatch[2]);
      
      skillName = skillName.replace(/\(.*\)/, '').trim();

      // Store all found skills in presentSkills map
      presentSkills.set(skillName, skillValue);
    }
  });

  // --- Populate standard 'dice' rolls ---
  // Always include SAN roll, using extracted sanValue
  categories.dice.push(`1d100<=${sanValue} 【正気度ロール】`); 
  categories.dice.push(`CCB<=${presentSkills.get("アイデア") || initialValues["アイデア"] || 0} 【アイデア】`);
  categories.dice.push(`CCB<=${presentSkills.get("幸運") || initialValues["幸運"] || 0} 【幸運】`);
  categories.dice.push(`CCB<=${presentSkills.get("知識") || initialValues["知識"] || 0} 【知識】`);

  // --- Populate standard 'explore' rolls ---
  categories.explore.push(`CCB<=${presentSkills.get("目星") || initialValues["目星"] || 0} 【目星】`);
  categories.explore.push(`CCB<=${presentSkills.get("聞き耳") || initialValues["聞き耳"] || 0} 【聞き耳】`);
  categories.explore.push(`CCB<=${presentSkills.get("図書館") || initialValues["図書館"] || 0} 【図書館】`);

  // --- Remaining skill categorizations (for skills not explicitly handled in dice/explore pre-population) ---
  // Iterate through presentSkills to categorize the rest
  presentSkills.forEach((skillValue, skillName) => {
    // Skip skills already explicitly added to dice or explore categories
    if (["アイデア", "幸運", "知識", "目星", "聞き耳", "図書館", "SAN"].includes(skillName)) {
      return;
    }
    
    const formattedSkillLine = `CCB<=${skillValue} 【${skillName}】`;

    // Categorization logic for remaining skills
    if (["回避", "こぶし", "キック", "組み付き", "頭突き", "投擲", "マーシャルアーツ", "拳銃", "サブマシンガン", "ショットガン", "マシンガン", "ライフル", "ソード", "日本刀", "ナイフ"].some(s => skillName.includes(s)) || /^(小さな棍棒|大きな棍棒|小さい棍棒|大きい棍棒)/.test(skillName)) {
        categories.battle.push(formattedSkillLine);
    } else if (["応急手当", "鍵開け", "隠す", "隠れる", "忍び歩き", "写真術", "精神分析", "追跡", "登攀", "運転", "機械修理", "重機械操作", "乗馬", "水泳", "製作", "操縦", "跳躍", "電気修理", "ナビゲート", "変装"].some(s => skillName.includes(s)) || /^(運転|製作|操縦)/.test(skillName)) {
        categories.action.push(formattedSkillLine);
    } else if (["言いくるめ", "信用", "説得", "値切り", "母国語", "その他言語"].some(s => skillName.includes(s))) {
        categories.talk.push(formattedSkillLine);
    } else if (["芸術"].includes(skillName) || skillName.startsWith("芸術")) {
        categories.knowledge.push(formattedSkillLine);
    } else if(["クトゥルフ神話", "医学", "オカルト", "化学", "経理", "考古学", "コンピューター", "心理学", "人類学", "生物学", "地質学", "電子工学", "天文学", "博物学", "物理学", "法律", "薬学", "歴史"].some(s => skillName.includes(s))) {
        categories.knowledge.push(formattedSkillLine);
    } else {
        categories.knowledge.push(formattedSkillLine);
    }
  });


  // Generate initial values based on missing skills
  const missingInitials = Object.entries(initialValues)
    .filter(([skill, _]) => !presentSkills.has(skill))
    .map(([skill, value]) => `CCB<=${value} 【${skill}】`);

  let actualDamageRoll = '';
  if (damageBonus === '0') {
    actualDamageRoll = '1d3+0 【ダメージ判定】';
  } else if (damageBonus === '+1d4') {
    actualDamageRoll = '1d4+0 【ダメージ判定】';
  } else if (damageBonus === '+1d6') {
    actualDamageRoll = '1d6+0 【ダメージ判定】';
  } else {
    actualDamageRoll = '1d3+0 【ダメージ判定】'; // Fallback
  }

  const abilityScoreLines = [
    `CCB<=${str * 5} 【STR × 5】`,
    `CCB<=${con * 5} 【CON × 5】`,
    `CCB<=${pow * 5} 【POW × 5】`,
    `CCB<=${dex * 5} 【DEX × 5】`,
    `CCB<=${app * 5} 【APP × 5】`,
    `CCB<=${siz * 5} 【SIZ × 5】`,
    `CCB<=${int * 5} 【INT × 5】`,
    `CCB<=${edu * 5} 【EDU × 5}`
  ];

  const output = [
    "◼️ダイス",
    ...categories.dice,
    "\n🟦探索技能",
    ...categories.explore,
    "\n🟥戦闘技能",
    ...categories.battle,
    "\n🟧行動技能・他",
    ...categories.action,
    "\n🟪交渉技能",
    ...categories.talk,
    "\n⬜️知識技能",
    ...categories.knowledge,
    "\n========初期値========",
    ...missingInitials,
    "\n========能力値========",
    actualDamageRoll,
    ...abilityScoreLines
  ].join("\n");

  document.getElementById("output").value = output;
}

function copyOutput() {
  const output = document.getElementById("output");
  navigator.clipboard.writeText(output.value).then(() => {
    alert("コピーしました");
    gtag('event', 'copy_output', {
      'event_category': 'button',
      'event_label': 'コピー',
      'value': 1
    });
  }).catch(err => {
    alert("コピーに失敗しました: " + err);
  });
}
</script>

</body>
</html>
